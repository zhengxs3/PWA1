<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#317EFB" />
    <title>PWA Démo – Accueil</title>

    <!-- Manifest & icône -->
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" href="icon.png" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header>
      <h1>PWA Démo 🚀</h1>
      <button
        id="notify-btn"
        aria-label="Activer les notifications"
        title="Activer les notifications"
      >
        🔔 Notif immédiate
      </button>
      <button
        id="delayed-notify-btn"
        aria-label="Tester notification différée"
        title="Tester notification avec délai"
      >
        ⏱️ Notif après 2 sec
      </button>
    </header>

    <main>
      <p>
        Bienvenue ! Cette page d'accueil est conçue pour démontrer les
        <strong>fonctionnalités essentielles d'une Progressive Web App</strong>.
      </p>
      <ul>
        <li>Fonctionne hors‑ligne (grâce au Service Worker).</li>
        <li>Peut être <em>installée</em> sur l'écran d'accueil.</li>
        <li>Affiche l'état du réseau en direct.</li>
        <li>Permet de recevoir des notifications push.</li>
      </ul>
      <p id="network-info">
        Statut réseau : <span id="status" class="offline">hors‑ligne</span>
      </p>
    </main>

    <!-- Bannière d'installation personnalisée -->
    <div id="install-banner">
      <span>Installer l'application ?</span>
      <button id="install-btn">Installer</button>
    </div>

    <!-- Script d'enregistrement du Service Worker & logiques PWA -->
    <script src="sw-register.js"></script>
    <script>
      // Indicateur réseau
      const statusEl = document.getElementById("status");
      function updateOnlineStatus() {
        const online = navigator.onLine;
        statusEl.textContent = online ? "en ligne" : "hors‑ligne";
        statusEl.className = online ? "online" : "offline";
      }
      window.addEventListener("online", updateOnlineStatus);
      window.addEventListener("offline", updateOnlineStatus);
      updateOnlineStatus();

      // Bouton cloche notifications immédiates
      const btn = document.getElementById("notify-btn");
      btn.addEventListener("click", async () => {
        console.log("🔔 Bouton cliqué");

        if (!("Notification" in window)) {
          alert("Notifications non prises en charge");
          return;
        }

        let perm = Notification.permission;
        console.log("🔔 Permission actuelle :", perm);

        if (perm === "default") {
          perm = await Notification.requestPermission();
          console.log("🔔 Permission après requête :", perm);
        }

        if (perm === "granted") {
          const reg = await navigator.serviceWorker.ready;
          console.log("🔔 Service worker prêt ?", reg);

          if (reg && reg.active) {
            console.log("🔔 Envoi message test-notif au SW");
            reg.active.postMessage({ action: "test-notif" });
          } else {
            console.warn("❌ Service Worker non actif");
          }
        } else {
          alert("Notifications refusées ; impossible d’activer.");
        }
      });

      // Bouton notification différée (2s)
      const delayBtn = document.getElementById("delayed-notify-btn");
      delayBtn.addEventListener("click", async () => {
        console.log("⏱️ Bouton notif différée cliqué");

        if (Notification.permission !== 'granted') {
          await Notification.requestPermission();
        }

        const reg = await navigator.serviceWorker.ready;
        if (reg && reg.active) {
          console.log("⏱️ Envoi du message différé dans 2s");
          setTimeout(() => {
            reg.active.postMessage({ action: "test-notif" });
          }, 2000);
        }
      });
    </script>
  </body>
</html>
