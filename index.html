<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#317EFB" />
    <title>PWAÂ DÃ©moÂ â€“Â Accueil</title>

    <!-- Manifest & icÃ´ne -->
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" href="icon.png" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header>
      <h1>PWAÂ DÃ©mo ğŸš€</h1>
      <button
        id="notify-btn"
        aria-label="Activer les notifications"
        title="Activer les notifications"
      >
        ğŸ”” Notif immÃ©diate
      </button>
      <button
        id="delayed-notify-btn"
        aria-label="Tester notification diffÃ©rÃ©e"
        title="Tester notification avec dÃ©lai"
      >
        â±ï¸ Notif aprÃ¨s 2 sec
      </button>
    </header>

    <main>
      <p>
        BienvenueÂ ! Cette page d'accueil est conÃ§ue pour dÃ©montrer les
        <strong>fonctionnalitÃ©s essentielles d'une Progressiveâ€¯Webâ€¯App</strong>.
      </p>
      <ul>
        <li>Fonctionne horsâ€‘ligne (grÃ¢ce au ServiceÂ Worker).</li>
        <li>Peut Ãªtre <em>installÃ©e</em> sur l'Ã©cran d'accueil.</li>
        <li>Affiche l'Ã©tat du rÃ©seau en direct.</li>
        <li>Permet de recevoir des notifications push.</li>
      </ul>
      <p id="network-info">
        Statut rÃ©seauÂ : <span id="status" class="offline">horsâ€‘ligne</span>
      </p>
    </main>

    <!-- BanniÃ¨re d'installation personnalisÃ©e -->
    <div id="install-banner">
      <span>Installer l'applicationÂ ?</span>
      <button id="install-btn">Installer</button>
    </div>

    <!-- Script d'enregistrement du ServiceÂ Worker & logiques PWA -->
    <script src="sw-register.js"></script>
    <script>
      // Indicateur rÃ©seau
      const statusEl = document.getElementById("status");
      function updateOnlineStatus() {
        const online = navigator.onLine;
        statusEl.textContent = online ? "enÂ ligne" : "horsâ€‘ligne";
        statusEl.className = online ? "online" : "offline";
      }
      window.addEventListener("online", updateOnlineStatus);
      window.addEventListener("offline", updateOnlineStatus);
      updateOnlineStatus();

      // Bouton cloche notifications immÃ©diates
      const btn = document.getElementById("notify-btn");
      btn.addEventListener("click", async () => {
        console.log("ğŸ”” Bouton cliquÃ©");

        if (!("Notification" in window)) {
          alert("Notifications non prises en charge");
          return;
        }

        let perm = Notification.permission;
        console.log("ğŸ”” Permission actuelle :", perm);

        if (perm === "default") {
          perm = await Notification.requestPermission();
          console.log("ğŸ”” Permission aprÃ¨s requÃªte :", perm);
        }

        if (perm === "granted") {
          const reg = await navigator.serviceWorker.ready;
          console.log("ğŸ”” Service worker prÃªt ?", reg);

          if (reg && reg.active) {
            console.log("ğŸ”” Envoi message test-notif au SW");
            reg.active.postMessage({ action: "test-notif" });
          } else {
            console.warn("âŒ Service Worker non actif");
          }
        } else {
          alert("Notifications refusÃ©esÂ ; impossible dâ€™activer.");
        }
      });

      // Bouton notification diffÃ©rÃ©e (2s)
      const delayBtn = document.getElementById("delayed-notify-btn");
      delayBtn.addEventListener("click", async () => {
        console.log("â±ï¸ Bouton notif diffÃ©rÃ©e cliquÃ©");

        if (Notification.permission !== 'granted') {
          await Notification.requestPermission();
        }

        const reg = await navigator.serviceWorker.ready;
        if (reg && reg.active) {
          console.log("â±ï¸ Envoi du message diffÃ©rÃ© dans 2s");
          setTimeout(() => {
            reg.active.postMessage({ action: "test-notif" });
          }, 2000);
        }
      });
    </script>
  </body>
</html>
